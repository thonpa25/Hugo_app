{{/* YouTube Video Embed Shortcode */}}
{{/* Usage Examples:
     {{< youtube id="dQw4w9WgXcQ" >}}
     {{< youtube id="dQw4w9WgXcQ" title="Rick Astley - Never Gonna Give You Up" >}}
     {{< youtube id="dQw4w9WgXcQ" autoplay="true" start="30" end="120" >}}
     {{< youtube url="https://www.youtube.com/watch?v=dQw4w9WgXcQ" >}}
*/}}

{{ $id := .Get "id" }}
{{ $url := .Get "url" }}
{{ $title := .Get "title" | default "YouTube Video" }}
{{ $width := .Get "width" | default "100%" }}
{{ $height := .Get "height" | default "315" }}
{{ $autoplay := .Get "autoplay" | default "false" }}
{{ $mute := .Get "mute" | default "false" }}
{{ $loop := .Get "loop" | default "false" }}
{{ $start := .Get "start" | default "" }}
{{ $end := .Get "end" | default "" }}
{{ $controls := .Get "controls" | default "true" }}
{{ $modestbranding := .Get "modestbranding" | default "false" }}
{{ $rel := .Get "rel" | default "false" }}
{{ $showinfo := .Get "showinfo" | default "true" }}
{{ $privacy := .Get "privacy" | default "false" }}
{{ $loading := .Get "loading" | default "lazy" }}
{{ $quality := .Get "quality" | default "hd720" }}
{{ $thumbnail := .Get "thumbnail" | default "maxresdefault" }}

{{/* Extract video ID from URL if provided */}}
{{ if and $url (not $id) }}
  {{ $urlParts := split $url "v=" }}
  {{ if gt (len $urlParts) 1 }}
    {{ $id = index (split (index $urlParts 1) "&") 0 }}
  {{ else }}
    {{ $urlParts = split $url "youtu.be/" }}
    {{ if gt (len $urlParts) 1 }}
      {{ $id = index (split (index $urlParts 1) "?") 0 }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if not $id }}
  <div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>YouTube Shortcode Error:</strong> No video ID provided. Please provide either an 'id' or 'url' parameter.
  </div>
{{ else }}

{{/* Build embed parameters */}}
{{ $params := slice }}

{{ if eq $autoplay "true" }}{{ $params = $params | append "autoplay=1" }}{{ end }}
{{ if eq $mute "true" }}{{ $params = $params | append "mute=1" }}{{ end }}
{{ if eq $loop "true" }}{{ $params = $params | append "loop=1" }}{{ $params = $params | append (printf "playlist=%s" $id) }}{{ end }}
{{ if eq $controls "false" }}{{ $params = $params | append "controls=0" }}{{ end }}
{{ if eq $modestbranding "true" }}{{ $params = $params | append "modestbranding=1" }}{{ end }}
{{ if eq $rel "false" }}{{ $params = $params | append "rel=0" }}{{ end }}
{{ if eq $showinfo "false" }}{{ $params = $params | append "showinfo=0" }}{{ end }}
{{ if $start }}{{ $params = $params | append (printf "start=%s" $start) }}{{ end }}
{{ if $end }}{{ $params = $params | append (printf "end=%s" $end) }}{{ end }}

{{/* Build base URL - use privacy-enhanced domain if requested */}}
{{ $baseUrl := "https://www.youtube.com" }}
{{ if eq $privacy "true" }}{{ $baseUrl = "https://www.youtube-nocookie.com" }}{{ end }}

{{/* Combine URL with parameters */}}
{{ $embedUrl := printf "%s/embed/%s" $baseUrl $id }}
{{ if $params }}{{ $embedUrl = printf "%s?%s" $embedUrl (delimit $params "&") }}{{ end }}

{{/* Thumbnail URL */}}
{{ $thumbnailUrl := printf "https://img.youtube.com/vi/%s/%s.jpg" $id $thumbnail }}

<div class="youtube-video-container" data-video-id="{{ $id }}">
  <!-- Video Loading Placeholder with Thumbnail -->
  <div class="video-loading-placeholder" id="yt-loading-{{ $id }}-{{ now.Unix }}" onclick="loadYouTubeVideo(this)">
    <div class="video-thumbnail" style="background-image: url('{{ $thumbnailUrl }}');">
      <div class="video-overlay">
        <div class="play-button">
          <svg width="68" height="48" viewBox="0 0 68 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M66.52 7.74C65.11 2.56 60.49 -1.25 56.05 0.19C51.61 1.63 7.05 2.93 4.14 6.85C1.23 10.77 0 23.27 0 23.27C0 23.27 1.23 35.77 4.14 39.69C7.05 43.61 51.61 44.91 56.05 46.35C60.49 47.79 65.11 44.98 66.52 39.8C68 34.46 68 23.27 68 23.27C68 23.27 68 12.08 66.52 7.74Z" fill="#FF0000"/>
            <path d="M45 24L27 14V34L45 24Z" fill="white"/>
          </svg>
        </div>
        <div class="video-title">{{ $title }}</div>
        <div class="video-duration" id="duration-{{ $id }}"></div>
      </div>
    </div>
    
    <!-- Loading State -->
    <div class="video-loading d-none">
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading video...</span>
      </div>
    </div>
  </div>
  
  <!-- YouTube Embed (loaded on demand) -->
  <div class="youtube-embed-wrapper d-none">
    <iframe
      class="youtube-embed"
      width="{{ $width }}"
      height="{{ $height }}"
      src="about:blank"
      data-src="{{ $embedUrl | safeURL }}"
      title="{{ $title }}"
      frameborder="0"
      loading="{{ $loading }}"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen>
    </iframe>
  </div>
  
  <!-- Video Information -->
  {{ with .Inner }}
  <div class="video-info">
    <div class="card">
      <div class="card-body">
        {{ . | markdownify }}
      </div>
    </div>
  </div>
  {{ end }}
</div>

<!-- Video Schema.org Markup for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": "{{ $title }}",
  "description": "{{ with .Inner }}{{ . | plainify | truncate 160 }}{{ else }}{{ $title }}{{ end }}",
  "thumbnailUrl": "{{ $thumbnailUrl }}",
  "uploadDate": "{{ now.Format "2006-01-02" }}",
  "contentUrl": "{{ $embedUrl }}",
  "embedUrl": "{{ $embedUrl }}",
  "publisher": {
    "@type": "Organization",
    "name": "YouTube",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.youtube.com/img/desktop/yt_1200.png"
    }
  }
}
</script>

{{ end }}

<!-- YouTube Video Styles -->
<style>
.youtube-video-container {
  position: relative;
  margin: 1.5rem 0;
  border-radius: 0.5rem;
  overflow: hidden;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.video-loading-placeholder {
  position: relative;
  cursor: pointer;
  aspect-ratio: 16 / 9;
  background: #000;
  border-radius: 0.5rem;
  overflow: hidden;
}

.video-thumbnail {
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  position: relative;
}

.video-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  transition: background-color 0.3s ease;
}

.video-loading-placeholder:hover .video-overlay {
  background: rgba(0, 0, 0, 0.5);
}

.play-button {
  transition: transform 0.3s ease;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}

.video-loading-placeholder:hover .play-button {
  transform: scale(1.1);
}

.video-title {
  color: white;
  font-size: 1.1rem;
  font-weight: 600;
  text-align: center;
  padding: 0 1rem;
  margin-top: 1rem;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
  line-height: 1.4;
}

.video-duration {
  color: white;
  font-size: 0.9rem;
  margin-top: 0.5rem;
  padding: 0.25rem 0.5rem;
  background: rgba(0, 0, 0, 0.7);
  border-radius: 0.25rem;
  font-family: monospace;
}

.video-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2;
}

.youtube-embed-wrapper {
  position: relative;
  width: 100%;
  height: 0;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
}

.youtube-embed {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 0.5rem;
}

.video-info {
  margin-top: 1rem;
}

.video-info .card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .video-title {
    font-size: 1rem;
    padding: 0 0.75rem;
  }
  
  .play-button svg {
    width: 56px;
    height: 40px;
  }
}

/* High contrast mode */
@media (prefers-contrast: high) {
  .video-overlay {
    background: rgba(0, 0, 0, 0.8);
  }
  
  .video-title {
    text-shadow: 0 1px 0 #000;
  }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  .play-button,
  .video-overlay {
    transition: none;
  }
}
</style>

<!-- YouTube Video JavaScript -->
<script>
function loadYouTubeVideo(placeholder) {
  const container = placeholder.closest('.youtube-video-container');
  const embedWrapper = container.querySelector('.youtube-embed-wrapper');
  const iframe = container.querySelector('.youtube-embed');
  const loading = placeholder.querySelector('.video-loading');
  
  // Show loading state
  loading.classList.remove('d-none');
  
  // Load the iframe
  iframe.src = iframe.getAttribute('data-src');
  
  // Hide placeholder and show embed
  setTimeout(() => {
    placeholder.classList.add('d-none');
    embedWrapper.classList.remove('d-none');
  }, 500);
}

// Lazy load video thumbnails and get durations
document.addEventListener('DOMContentLoaded', function() {
  const videoContainers = document.querySelectorAll('.youtube-video-container');
  
  videoContainers.forEach(container => {
    const videoId = container.getAttribute('data-video-id');
    const durationEl = container.querySelector(`#duration-${videoId}`);
    
    // Fetch video duration (this would require YouTube API key)
    // For now, we'll hide the duration element
    if (durationEl) {
      durationEl.style.display = 'none';
    }
  });
});
</script>