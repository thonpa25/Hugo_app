{{/* Contact Form Shortcode with Netlify Forms Integration */}}
{{/* Usage: {{< contact-form destination="dan@theonlinepart.com" subject="Website Contact" >}} */}}

{{ $destination := .Get "destination" | default "dan@theonlinepart.com" }}
{{ $subject := .Get "subject" | default "Contact Form Submission" }}
{{ $form_name := .Get "name" | default "contact-form" }}
{{ $recaptcha := .Get "recaptcha" | default false }}
{{ $honeypot := .Get "honeypot" | default true }}
{{ $success_url := .Get "success" | default "/contact/success/" }}

<div class="contact-form-wrapper">
  <form 
    name="{{ $form_name }}" 
    method="POST" 
    action="{{ $success_url }}"
    data-netlify="true"
    {{ if $recaptcha }}data-netlify-recaptcha="true"{{ end }}
    class="contact-form"
    id="{{ $form_name }}"
  >
    
    {{/* Hidden form name field for Netlify */}}
    <input type="hidden" name="form-name" value="{{ $form_name }}" />
    
    {{/* Email destination */}}
    <input type="hidden" name="destination" value="{{ $destination }}" />
    
    {{/* Subject line */}}
    <input type="hidden" name="subject" value="{{ $subject }}" />
    
    {{/* Honeypot spam protection */}}
    {{ if $honeypot }}
    <div style="display: none;">
      <label>Don't fill this out if you're human: 
        <input name="bot-field" />
      </label>
    </div>
    {{ end }}

    <div class="row">
      <div class="col-md-6 mb-4">
        <div class="form-group">
          <label for="name-{{ $form_name }}" class="form-label">
            Full Name <span class="text-danger">*</span>
          </label>
          <input 
            type="text" 
            class="form-control" 
            id="name-{{ $form_name }}" 
            name="name" 
            required
            placeholder="Your full name"
            aria-describedby="name-help-{{ $form_name }}"
          />
          <div id="name-help-{{ $form_name }}" class="form-text">We'll use this to address you in our response.</div>
          <div class="invalid-feedback">Please provide your name.</div>
        </div>
      </div>
      
      <div class="col-md-6 mb-4">
        <div class="form-group">
          <label for="email-{{ $form_name }}" class="form-label">
            Email Address <span class="text-danger">*</span>
          </label>
          <input 
            type="email" 
            class="form-control" 
            id="email-{{ $form_name }}" 
            name="email" 
            required
            placeholder="your.email@example.com"
            aria-describedby="email-help-{{ $form_name }}"
          />
          <div id="email-help-{{ $form_name }}" class="form-text">We'll respond to this email address.</div>
          <div class="invalid-feedback">Please provide a valid email address.</div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-4">
        <div class="form-group">
          <label for="phone-{{ $form_name }}" class="form-label">
            Phone Number
          </label>
          <input 
            type="tel" 
            class="form-control" 
            id="phone-{{ $form_name }}" 
            name="phone" 
            placeholder="+1 (555) 123-4567"
            aria-describedby="phone-help-{{ $form_name }}"
          />
          <div id="phone-help-{{ $form_name }}" class="form-text">Optional - for urgent inquiries.</div>
        </div>
      </div>
      
      <div class="col-md-6 mb-4">
        <div class="form-group">
          <label for="company-{{ $form_name }}" class="form-label">
            Company/Organization
          </label>
          <input 
            type="text" 
            class="form-control" 
            id="company-{{ $form_name }}" 
            name="company" 
            placeholder="Your company name"
            aria-describedby="company-help-{{ $form_name }}"
          />
          <div id="company-help-{{ $form_name }}" class="form-text">Optional - helps us understand your context.</div>
        </div>
      </div>
    </div>

    <div class="mb-4">
      <div class="form-group">
        <label for="inquiry-type-{{ $form_name }}" class="form-label">
          Inquiry Type
        </label>
        <select 
          class="form-select" 
          id="inquiry-type-{{ $form_name }}" 
          name="inquiry_type"
          aria-describedby="inquiry-type-help-{{ $form_name }}"
        >
          <option value="">Select inquiry type...</option>
          <option value="general">General Inquiry</option>
          <option value="sales">Sales & Pricing</option>
          <option value="support">Technical Support</option>
          <option value="partnership">Partnership Opportunity</option>
          <option value="press">Press & Media</option>
          <option value="other">Other</option>
        </select>
        <div id="inquiry-type-help-{{ $form_name }}" class="form-text">Helps us route your message to the right team.</div>
      </div>
    </div>

    <div class="mb-4">
      <div class="form-group">
        <label for="message-{{ $form_name }}" class="form-label">
          Message <span class="text-danger">*</span>
        </label>
        <textarea 
          class="form-control" 
          id="message-{{ $form_name }}" 
          name="message" 
          rows="6" 
          required
          placeholder="Please provide details about your inquiry..."
          aria-describedby="message-help-{{ $form_name }}"
          minlength="10"
          maxlength="5000"
        ></textarea>
        <div id="message-help-{{ $form_name }}" class="form-text">
          <span class="character-count">0</span>/5000 characters. Minimum 10 characters required.
        </div>
        <div class="invalid-feedback">Please provide a message with at least 10 characters.</div>
      </div>
    </div>

    {{/* Newsletter subscription option */}}
    <div class="mb-4">
      <div class="form-check">
        <input 
          class="form-check-input" 
          type="checkbox" 
          value="yes" 
          id="newsletter-{{ $form_name }}" 
          name="newsletter_signup"
        />
        <label class="form-check-label" for="newsletter-{{ $form_name }}">
          Subscribe to our newsletter for updates and special offers
        </label>
      </div>
    </div>

    {{/* Privacy policy agreement */}}
    <div class="mb-4">
      <div class="form-check">
        <input 
          class="form-check-input" 
          type="checkbox" 
          value="agreed" 
          id="privacy-{{ $form_name }}" 
          name="privacy_agreed"
          required
        />
        <label class="form-check-label" for="privacy-{{ $form_name }}">
          I agree to the <a href="/privacy-policy/" target="_blank">Privacy Policy</a> and consent to the processing of my personal data <span class="text-danger">*</span>
        </label>
        <div class="invalid-feedback">You must agree to the privacy policy to submit the form.</div>
      </div>
    </div>

    {{/* reCAPTCHA if enabled */}}
    {{ if $recaptcha }}
    <div class="mb-4">
      <div data-netlify-recaptcha="true"></div>
    </div>
    {{ end }}

    {{/* Submit button */}}
    <div class="form-group">
      <button 
        type="submit" 
        class="btn btn-primary btn-lg px-4"
        id="submit-{{ $form_name }}"
        data-loading-text="Sending..."
      >
        <i class="fas fa-paper-plane me-2"></i>
        Send Message
      </button>
      <div class="form-text mt-2">
        <small>We typically respond within 24 hours during business days.</small>
      </div>
    </div>
  </form>
</div>

{{/* Form validation and UX JavaScript */}}
<script>
(function() {
  'use strict';
  
  const form = document.getElementById('{{ $form_name }}');
  const submitBtn = document.getElementById('submit-{{ $form_name }}');
  const messageField = document.getElementById('message-{{ $form_name }}');
  const characterCount = document.querySelector('#{{ $form_name }} .character-count');
  
  if (!form || !submitBtn || !messageField || !characterCount) return;
  
  // Character counter for message field
  function updateCharacterCount() {
    const count = messageField.value.length;
    characterCount.textContent = count;
    
    if (count < 10) {
      characterCount.parentNode.classList.add('text-danger');
      characterCount.parentNode.classList.remove('text-success');
    } else if (count > 4500) {
      characterCount.parentNode.classList.add('text-warning');
      characterCount.parentNode.classList.remove('text-success');
    } else {
      characterCount.parentNode.classList.add('text-success');
      characterCount.parentNode.classList.remove('text-danger', 'text-warning');
    }
  }
  
  messageField.addEventListener('input', updateCharacterCount);
  messageField.addEventListener('keyup', updateCharacterCount);
  
  // Form submission handling
  form.addEventListener('submit', function(e) {
    // Update button state - Security: Use textContent and DOM manipulation
    submitBtn.disabled = true;
    
    // Clear and rebuild button content securely
    submitBtn.innerHTML = '';
    const spinnerIcon = document.createElement('i');
    spinnerIcon.className = 'fas fa-spinner fa-spin me-2';
    submitBtn.appendChild(spinnerIcon);
    submitBtn.appendChild(document.createTextNode('Sending...'));
    
    // Add Bootstrap validation classes
    form.classList.add('was-validated');
    
    // Check form validity
    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
      
      // Reset button securely
      submitBtn.disabled = false;
      submitBtn.innerHTML = '';
      const planeIcon = document.createElement('i');
      planeIcon.className = 'fas fa-paper-plane me-2';
      submitBtn.appendChild(planeIcon);
      submitBtn.appendChild(document.createTextNode('Send Message'));
      
      // Focus first invalid field
      const firstInvalid = form.querySelector(':invalid');
      if (firstInvalid) {
        firstInvalid.focus();
      }
      
      return false;
    }
  });
  
  // Reset button state if form submission fails
  form.addEventListener('error', function() {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '';
    const planeIcon = document.createElement('i');
    planeIcon.className = 'fas fa-paper-plane me-2';
    submitBtn.appendChild(planeIcon);
    submitBtn.appendChild(document.createTextNode('Send Message'));
  });
  
  // Initialize character count
  updateCharacterCount();
  
})();
</script>

{{/* Form-specific styles */}}
<style>
.contact-form-wrapper {
  max-width: 800px;
  margin: 0 auto;
}

.contact-form {
  background: #ffffff;
  padding: 2rem;
  border-radius: 0.5rem;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  border: 1px solid rgba(0, 0, 0, 0.125);
}

.contact-form .form-label {
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: #495057;
}

.contact-form .form-control,
.contact-form .form-select {
  border-radius: 0.375rem;
  border: 1px solid #ced4da;
  padding: 0.75rem;
  font-size: 1rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.contact-form .form-control:focus,
.contact-form .form-select:focus {
  border-color: var(--color-primary, #0AA8A7);
  box-shadow: 0 0 0 0.2rem rgba(10, 168, 167, 0.25);
}

.contact-form .text-danger {
  color: #dc3545 !important;
}

.contact-form .text-success {
  color: #198754 !important;
}

.contact-form .text-warning {
  color: #ffc107 !important;
}

.contact-form .btn-primary {
  background-color: var(--color-primary, #0AA8A7);
  border-color: var(--color-primary, #0AA8A7);
  padding: 0.75rem 2rem;
  font-weight: 600;
  transition: all 0.15s ease-in-out;
}

.contact-form .btn-primary:hover {
  background-color: var(--color-secondary, #376f92);
  border-color: var(--color-secondary, #376f92);
  transform: translateY(-1px);
}

.contact-form .btn-primary:disabled {
  background-color: #6c757d;
  border-color: #6c757d;
  transform: none;
}

.contact-form .form-text {
  font-size: 0.875rem;
  color: #6c757d;
}

.contact-form .invalid-feedback {
  display: block;
  width: 100%;
  margin-top: 0.25rem;
  font-size: 0.875rem;
  color: #dc3545;
}

.contact-form.was-validated .form-control:invalid,
.contact-form.was-validated .form-select:invalid {
  border-color: #dc3545;
  padding-right: calc(1.5em + 0.75rem);
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right calc(0.375em + 0.1875rem) center;
  background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.contact-form.was-validated .form-control:valid,
.contact-form.was-validated .form-select:valid {
  border-color: #198754;
  padding-right: calc(1.5em + 0.75rem);
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.69-.04L4.88 4.6l.69-.04L7.43 2.68l-.69.04L4.88 4.6l-.69.04L2.3 6.73z'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right calc(0.375em + 0.1875rem) center;
  background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

@media (max-width: 768px) {
  .contact-form {
    padding: 1.5rem;
  }
  
  .contact-form .btn-primary {
    width: 100%;
    padding: 1rem;
  }
}
</style>