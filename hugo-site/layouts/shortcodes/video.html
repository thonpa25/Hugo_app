{{/* Universal Video Embed Shortcode */}}
{{/* Automatically detects platform and embeds the appropriate player */}}
{{/* Usage Examples:
     {{< video src="https://www.youtube.com/watch?v=dQw4w9WgXcQ" >}}
     {{< video src="https://vimeo.com/123456789" >}}
     {{< video src="/videos/local-video.mp4" >}}
     {{< video platform="youtube" id="dQw4w9WgXcQ" >}}
     {{< video platform="vimeo" id="123456789" >}}
*/}}

{{ $src := .Get "src" }}
{{ $platform := .Get "platform" }}
{{ $id := .Get "id" }}
{{ $title := .Get "title" | default "Video" }}
{{ $width := .Get "width" | default "100%" }}
{{ $height := .Get "height" | default "315" }}
{{ $autoplay := .Get "autoplay" | default "false" }}
{{ $controls := .Get "controls" | default "true" }}
{{ $muted := .Get "muted" | default "false" }}
{{ $loop := .Get "loop" | default "false" }}
{{ $poster := .Get "poster" | default "" }}
{{ $preload := .Get "preload" | default "metadata" }}

{{/* Auto-detect platform from URL if not specified */}}
{{ if and $src (not $platform) }}
  {{ if findRE "youtube\\.com|youtu\\.be" $src }}
    {{ $platform = "youtube" }}
  {{ else if findRE "vimeo\\.com" $src }}
    {{ $platform = "vimeo" }}
  {{ else if findRE "dailymotion\\.com" $src }}
    {{ $platform = "dailymotion" }}
  {{ else if findRE "\\.(mp4|webm|ogg|mov|avi)$" $src }}
    {{ $platform = "html5" }}
  {{ else }}
    {{ $platform = "html5" }}
  {{ end }}
{{ end }}

<div class="universal-video-container" data-platform="{{ $platform }}">
  
  {{ if eq $platform "youtube" }}
    {{/* YouTube Video */}}
    {{ if or $src $id }}
      {{ $ytId := $id }}
      {{ if and $src (not $ytId) }}
        {{/* Extract YouTube ID from URL */}}
        {{ if findRE "youtu\\.be/([^?]+)" $src }}
          {{ $ytId = replaceRE ".*youtu\\.be/([^?]+).*" "$1" $src }}
        {{ else if findRE "youtube\\.com/watch\\?v=([^&]+)" $src }}
          {{ $ytId = replaceRE ".*[?&]v=([^&]+).*" "$1" $src }}
        {{ end }}
      {{ end }}
      <div class="video-wrapper youtube-video ratio ratio-16x9">
        <iframe 
          src="https://www.youtube.com/embed/{{ $ytId }}?{{ if eq $autoplay "true" }}autoplay=1&{{ end }}{{ if eq $controls "false" }}controls=0&{{ end }}{{ if eq $muted "true" }}mute=1&{{ end }}{{ if eq $loop "true" }}loop=1&playlist={{ $ytId }}{{ end }}"
          title="{{ $title }}"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen>
        </iframe>
      </div>
    {{ else }}
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        YouTube video requires either 'src' or 'id' parameter.
      </div>
    {{ end }}
    
  {{ else if eq $platform "vimeo" }}
    {{/* Vimeo Video */}}
    {{ if or $src $id }}
      {{ $vimeoId := $id }}
      {{ if and $src (not $vimeoId) }}
        {{/* Extract Vimeo ID from URL */}}
        {{ $vimeoId = replaceRE ".*vimeo\\.com/([0-9]+).*" "$1" $src }}
      {{ end }}
      <div class="video-wrapper vimeo-video ratio ratio-16x9">
        <iframe 
          src="https://player.vimeo.com/video/{{ $vimeoId }}?{{ if eq $autoplay "true" }}autoplay=1&{{ end }}{{ if eq $muted "true" }}muted=1&{{ end }}{{ if eq $loop "true" }}loop=1{{ end }}"
          title="{{ $title }}"
          frameborder="0"
          allow="autoplay; fullscreen; picture-in-picture"
          allowfullscreen>
        </iframe>
      </div>
    {{ else }}
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Vimeo video requires either 'src' or 'id' parameter.
      </div>
    {{ end }}
    
  {{ else if eq $platform "dailymotion" }}
    {{/* Dailymotion Video */}}
    {{ $dmId := $id }}
    {{ if and $src (not $dmId) }}
      {{ $urlParts := split $src "/" }}
      {{ if gt (len $urlParts) 0 }}
        {{ $lastPart := index $urlParts (sub (len $urlParts) 1) }}
        {{ $dmId = index (split $lastPart "?") 0 }}
      {{ end }}
    {{ end }}
    
    {{ if $dmId }}
      <div class="dailymotion-video-container">
        <iframe
          class="dailymotion-embed"
          src="https://www.dailymotion.com/embed/video/{{ $dmId }}?autoplay={{ if eq $autoplay "true" }}1{{ else }}0{{ end }}&mute={{ if eq $muted "true" }}1{{ else }}0{{ end }}"
          width="{{ $width }}"
          height="{{ $height }}"
          title="{{ $title }}"
          frameborder="0"
          allowfullscreen>
        </iframe>
      </div>
    {{ else }}
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Dailymotion video requires either 'src' or 'id' parameter.
      </div>
    {{ end }}
    
  {{ else if eq $platform "html5" }}
    {{/* HTML5 Video */}}
    {{ if $src }}
      <div class="html5-video-container">
        <video
          class="html5-video"
          width="{{ $width }}"
          height="{{ $height }}"
          {{ if eq $controls "true" }}controls{{ end }}
          {{ if eq $autoplay "true" }}autoplay{{ end }}
          {{ if eq $muted "true" }}muted{{ end }}
          {{ if eq $loop "true" }}loop{{ end }}
          {{ if $poster }}poster="{{ $poster }}"{{ end }}
          preload="{{ $preload }}"
          title="{{ $title }}"
        >
          {{/* Support multiple video formats */}}
          {{ $videoExts := slice "mp4" "webm" "ogg" }}
          {{ $baseSrc := replaceRE "\\.[^.]+$" "" $src }}
          {{ $srcExt := replaceRE ".*\\." "" $src }}
          
          {{/* Add the specified source */}}
          <source src="{{ $src }}" type="video/{{ $srcExt }}">
          
          {{/* Try to find alternative formats */}}
          {{ range $videoExts }}
            {{ if ne . $srcExt }}
              {{ $altSrc := printf "%s.%s" $baseSrc . }}
              <source src="{{ $altSrc }}" type="video/{{ . }}">
            {{ end }}
          {{ end }}
          
          {{/* Fallback content */}}
          <p class="text-muted">
            Your browser doesn't support HTML5 video. 
            <a href="{{ $src }}" download>Download the video</a> instead.
          </p>
        </video>
        
        {{/* Video Information */}}
        {{ with .Inner }}
        <div class="video-info mt-3">
          <div class="card">
            <div class="card-body">
              {{ . | markdownify }}
            </div>
          </div>
        </div>
        {{ end }}
      </div>
    {{ else }}
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        HTML5 video requires 'src' parameter.
      </div>
    {{ end }}
    
  {{ else }}
    {{/* Unknown platform */}}
    <div class="alert alert-danger">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <strong>Unsupported Video Platform:</strong> 
      {{ if $platform }}
        Platform "{{ $platform }}" is not supported.
      {{ else }}
        Could not detect video platform from the provided URL.
      {{ end }}
      <br>
      <small>Supported platforms: YouTube, Vimeo, Dailymotion, HTML5 video files.</small>
    </div>
  {{ end }}
  
</div>

<!-- Universal Video Styles -->
<style>
.universal-video-container {
  position: relative;
  margin: 1.5rem 0;
}

/* Dailymotion specific styles */
.dailymotion-video-container {
  position: relative;
  width: 100%;
  height: 0;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  border-radius: 0.5rem;
  overflow: hidden;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.dailymotion-embed {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 0.5rem;
}

/* HTML5 video specific styles */
.html5-video-container {
  position: relative;
  border-radius: 0.5rem;
  overflow: hidden;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  background: #000;
}

.html5-video {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 0.5rem;
  background: #000;
}

.html5-video:focus {
  outline: 2px solid var(--color-primary, #0AA8A7);
  outline-offset: 2px;
}

/* Video info styles */
.video-info .card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

/* Responsive design */
@media (max-width: 768px) {
  .universal-video-container {
    margin: 1rem 0;
  }
  
  .html5-video {
    border-radius: 0.375rem;
  }
  
  .dailymotion-video-container,
  .html5-video-container {
    border-radius: 0.375rem;
  }
}

/* High contrast mode */
@media (prefers-contrast: high) {
  .dailymotion-video-container,
  .html5-video-container {
    border: 2px solid #000;
  }
}

/* Print styles */
@media print {
  .universal-video-container {
    page-break-inside: avoid;
  }
  
  .dailymotion-embed,
  .html5-video {
    display: none;
  }
  
  .universal-video-container::after {
    content: "Video: " attr(data-platform) " - " attr(title);
    display: block;
    padding: 1rem;
    border: 1px solid #000;
    text-align: center;
    font-weight: bold;
  }
}
</style>

<!-- Video Schema.org Markup -->
{{ if ne $platform "unknown" }}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": "{{ $title }}",
  "description": "{{ with .Inner }}{{ . | plainify | truncate 160 }}{{ else }}{{ $title }}{{ end }}",
  {{ if $poster }}"thumbnailUrl": "{{ $poster }}",{{ end }}
  "uploadDate": "{{ now.Format "2006-01-02" }}",
  {{ if $src }}"contentUrl": "{{ $src }}",{{ end }}
  "publisher": {
    "@type": "Organization",
    "name": "{{ .Site.Title }}"
  }
}
</script>
{{ end }}