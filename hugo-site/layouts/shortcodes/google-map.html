{{/* Google Maps Embed Shortcode */}}
{{/* Usage Examples:
     {{< google-map address="1600 Amphitheatre Parkway, Mountain View, CA" >}}
     {{< google-map lat="37.4221" lng="-122.0841" zoom="15" >}}
     {{< google-map place-id="ChIJN1t_tDeuEmsRUsoyG83frY4" >}}
     {{< google-map query="restaurants near me" >}}
*/}}

{{ $address := .Get "address" }}
{{ $lat := .Get "lat" }}
{{ $lng := .Get "lng" }}
{{ $placeId := .Get "place-id" }}
{{ $query := .Get "query" }}
{{ $zoom := .Get "zoom" | default "15" }}
{{ $width := .Get "width" | default "100%" }}
{{ $height := .Get "height" | default "400" }}
{{ $style := .Get "style" | default "default" }}
{{ $title := .Get "title" | default "Map" }}
{{ $api_key := .Site.Params.google_maps_api_key | default "" }}
{{ $embed_api_key := .Site.Params.google_maps_embed_api_key | default $api_key }}
{{ $loading := .Get "loading" | default "lazy" }}
{{ $allowfullscreen := .Get "allowfullscreen" | default true }}
{{ $referrerpolicy := .Get "referrerpolicy" | default "no-referrer-when-downgrade" }}

{{/* Build the embed URL */}}
{{ $baseUrl := "https://www.google.com/maps/embed/v1/" }}
{{ $embedUrl := "" }}
{{ $params := slice }}

{{/* Add API key if available */}}
{{ if $embed_api_key }}
  {{ $params = $params | append (printf "key=%s" $embed_api_key) }}
{{ end }}

{{/* Add zoom parameter */}}
{{ $params = $params | append (printf "zoom=%s" $zoom) }}

{{/* Determine embed mode and build URL */}}
{{ if $address }}
  {{/* Address-based embed */}}
  {{ $embedUrl = printf "%splace" $baseUrl }}
  {{ $params = $params | append (printf "q=%s" ($address | urlquery)) }}
{{ else if and $lat $lng }}
  {{/* Coordinate-based embed */}}
  {{ $embedUrl = printf "%sview" $baseUrl }}
  {{ $params = $params | append (printf "center=%s,%s" $lat $lng) }}
{{ else if $placeId }}
  {{/* Place ID-based embed */}}
  {{ $embedUrl = printf "%splace" $baseUrl }}
  {{ $params = $params | append (printf "place_id=%s" $placeId) }}
{{ else if $query }}
  {{/* Search query-based embed */}}
  {{ $embedUrl = printf "%ssearch" $baseUrl }}
  {{ $params = $params | append (printf "q=%s" ($query | urlquery)) }}
{{ else }}
  {{/* Default to a generic world map */}}
  {{ $embedUrl = printf "%sview" $baseUrl }}
  {{ $params = $params | append "center=0,0" }}
  {{ $zoom = "2" }}
  {{ $params = $params | append (printf "zoom=%s" $zoom) }}
{{ end }}

{{/* Combine URL with parameters */}}
{{ $finalUrl := printf "%s?%s" $embedUrl (delimit $params "&") }}

{{/* Map style configurations */}}
{{ $styleClass := "google-map-default" }}
{{ $mapStyles := dict }}
{{ if eq $style "satellite" }}
  {{ $styleClass = "google-map-satellite" }}
  {{ $params = $params | append "maptype=satellite" }}
{{ else if eq $style "terrain" }}
  {{ $styleClass = "google-map-terrain" }}
  {{ $params = $params | append "maptype=terrain" }}
{{ else if eq $style "hybrid" }}
  {{ $styleClass = "google-map-hybrid" }}
  {{ $params = $params | append "maptype=hybrid" }}
{{ end }}

<div class="google-map-container {{ $styleClass }}" data-map-config='{{ dict "address" $address "lat" $lat "lng" $lng "zoom" $zoom "style" $style | jsonify }}'>
  <!-- Map Loading Placeholder -->
  <div class="map-loading-placeholder" id="map-loading-{{ now.Unix }}">
    <div class="d-flex align-items-center justify-content-center h-100">
      <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading map...</span>
        </div>
        <p class="text-muted">Loading {{ $title }}...</p>
      </div>
    </div>
  </div>
  
  <!-- Google Maps Embed -->
  <iframe
    class="google-map-embed"
    width="{{ $width }}"
    height="{{ $height }}"
    style="border:0; width: 100%; height: {{ $height }}px;"
    loading="{{ $loading }}"
    {{ if $allowfullscreen }}allowfullscreen{{ end }}
    referrerpolicy="{{ $referrerpolicy }}"
    src="{{ $finalUrl | safeURL }}"
    title="{{ $title }}"
    aria-label="{{ $title }}"
    onload="this.parentNode.querySelector('.map-loading-placeholder').style.display='none';"
    onerror="this.parentNode.querySelector('.map-loading-placeholder').innerHTML='<div class=\'alert alert-warning\'><i class=\'fas fa-exclamation-triangle me-2\'></i>Map failed to load. Please try again later.</div>';">
  </iframe>
  
  <!-- Map Controls (if interactive features are needed) -->
  {{ if .Get "show-controls" }}
  <div class="map-controls">
    <div class="btn-group btn-group-sm" role="group" aria-label="Map controls">
      <button type="button" class="btn btn-outline-primary" onclick="toggleMapStyle(this)" data-style="roadmap">
        <i class="fas fa-map me-1"></i>Map
      </button>
      <button type="button" class="btn btn-outline-primary" onclick="toggleMapStyle(this)" data-style="satellite">
        <i class="fas fa-satellite me-1"></i>Satellite
      </button>
      <button type="button" class="btn btn-outline-primary" onclick="toggleMapStyle(this)" data-style="terrain">
        <i class="fas fa-mountain me-1"></i>Terrain
      </button>
    </div>
    
    {{ if or $address $query }}
    <div class="mt-2">
      <a href="https://www.google.com/maps/search/{{ if $address }}{{ $address | urlquery }}{{ else }}{{ $query | urlquery }}{{ end }}" 
         target="_blank" 
         class="btn btn-sm btn-primary">
        <i class="fas fa-external-link-alt me-1"></i>
        Open in Google Maps
      </a>
    </div>
    {{ end }}
  </div>
  {{ end }}
  
  <!-- Map Information Panel -->
  {{ with .Inner }}
  <div class="map-info-panel">
    <div class="card">
      <div class="card-body">
        {{ . | markdownify }}
      </div>
    </div>
  </div>
  {{ end }}
</div>

<!-- Fallback for when JavaScript is disabled -->
<noscript>
  <div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    <strong>JavaScript is disabled.</strong> 
    {{ if or $address $query }}
    <a href="https://www.google.com/maps/search/{{ if $address }}{{ $address | urlquery }}{{ else }}{{ $query | urlquery }}{{ end }}" 
       target="_blank" class="alert-link">
      Click here to view the map in Google Maps
    </a>.
    {{ else }}
    Please enable JavaScript to view the interactive map.
    {{ end }}
  </div>
</noscript>

<!-- Map Styles and JavaScript -->
<style>
.google-map-container {
  position: relative;
  margin: 1.5rem 0;
  border-radius: 0.5rem;
  overflow: hidden;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  border: 1px solid rgba(0, 0, 0, 0.125);
}

.google-map-embed {
  display: block;
  border-radius: 0.5rem;
}

.map-loading-placeholder {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #f8f9fa;
  z-index: 1;
  min-height: {{ $height }}px;
}

.map-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 2;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px;
  border-radius: 0.375rem;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.map-info-panel {
  margin-top: 1rem;
}

.map-info-panel .card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .google-map-container {
    margin: 1rem 0;
  }
  
  .map-controls {
    position: static;
    margin-top: 0.5rem;
    background: transparent;
    padding: 0;
    box-shadow: none;
  }
  
  .map-controls .btn-group {
    width: 100%;
  }
  
  .map-controls .btn {
    flex: 1;
  }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  .google-map-container {
    border: 2px solid #000;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  .spinner-border {
    animation: none;
  }
}
</style>

{{ if .Get "show-controls" }}
<script>
function toggleMapStyle(button) {
  const style = button.getAttribute('data-style');
  const container = button.closest('.google-map-container');
  const iframe = container.querySelector('.google-map-embed');
  
  if (iframe && style) {
    const currentSrc = iframe.src;
    const url = new URL(currentSrc);
    
    // Update maptype parameter
    url.searchParams.set('maptype', style === 'roadmap' ? '' : style);
    
    // Remove empty maptype parameter
    if (!url.searchParams.get('maptype')) {
      url.searchParams.delete('maptype');
    }
    
    iframe.src = url.toString();
    
    // Update active button
    container.querySelectorAll('.map-controls .btn').forEach(btn => {
      btn.classList.remove('active');
    });
    button.classList.add('active');
  }
}
</script>
{{ end }}