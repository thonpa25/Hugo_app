name: CloudCannon Sync

on:
  # Trigger on push to main branch
  push:
    branches: [ main ]
    paths:
      - 'hugo-site/**'
      - '.github/workflows/cloudcannon-sync.yml'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'Deployment message'
        required: false
        default: 'Manual sync to CloudCannon'

jobs:
  notify-cloudcannon:
    name: Notify CloudCannon of Changes
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2  # Get last 2 commits for comparison
    
    - name: Get Changed Files
      id: changed_files
      run: |
        echo "files=$(git diff --name-only HEAD^ HEAD | grep '^hugo-site/' | head -20 | tr '\n' ' ')" >> $GITHUB_OUTPUT
        echo "count=$(git diff --name-only HEAD^ HEAD | grep '^hugo-site/' | wc -l)" >> $GITHUB_OUTPUT
    
    - name: Trigger CloudCannon Build
      if: steps.changed_files.outputs.count > 0
      run: |
        if [ -n "${{ secrets.CLOUDCANNON_BUILD_HOOK }}" ]; then
          echo "🔄 Triggering CloudCannon build..."
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            "${{ secrets.CLOUDCANNON_BUILD_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "branch": "main",
              "commit": "${{ github.sha }}",
              "message": "${{ github.event.head_commit.message || github.event.inputs.deploy_message }}",
              "author": "${{ github.actor }}",
              "files_changed": "${{ steps.changed_files.outputs.count }}",
              "timestamp": "${{ github.event.head_commit.timestamp }}"
            }')
          
          if [ "$response" = "200" ] || [ "$response" = "201" ] || [ "$response" = "202" ]; then
            echo "✅ CloudCannon build triggered successfully (HTTP $response)"
          else
            echo "⚠️ CloudCannon webhook returned HTTP $response"
          fi
        else
          echo "ℹ️ CLOUDCANNON_BUILD_HOOK not configured. CloudCannon will sync automatically if connected."
        fi
    
    - name: Build Summary
      run: |
        echo "## 📊 Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Files Changed:** ${{ steps.changed_files.outputs.count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Message:** ${{ github.event.head_commit.message || github.event.inputs.deploy_message }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🚀 Deployment Targets" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ GitHub Repository Updated" >> $GITHUB_STEP_SUMMARY
        echo "- 🔄 CloudCannon Auto-Sync Active" >> $GITHUB_STEP_SUMMARY
        echo "- 🔄 Netlify Auto-Deploy Active" >> $GITHUB_STEP_SUMMARY